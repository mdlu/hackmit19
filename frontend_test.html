<!DOCTYPE html>
<html>
    <head>

    </head>
    <body>

        <button id="start">Record Audio</button>
        <a id="download">Download</a>

        <p id="output"></p>

        <script>

            function print(stuff){
                let el = document.getElementById("output");
                el.innerHTML = el.textContent + " \\ " + stuff;
            }

            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    print("beginning");
                    const mediaRecorder = new MediaRecorder(stream);
                    mediaRecorder.start();

                    const audioChunks = [];

                    mediaRecorder.addEventListener("dataavailable", event => {
                    audioChunks.push(event.data);
                    });

                    mediaRecorder.addEventListener("stop", () => {
                        print("stopping");
                        const audioBlob = new Blob(audioChunks);
                        const audioUrl = URL.createObjectURL(audioBlob);
                        const down = document.getElementById("download");
                        down.href = audioUrl;
                        down.download = "asdf.wav";
                        down.click();

                    });

                    setTimeout(() => {
                    mediaRecorder.stop();
                    }, 3000);
                });

            /*
            let stream = null;
            navigator.mediaDevices.getUserMedia({ audio: true, video: false }).then(function(str){
                print("Permissions Granted")
                stream = str;
            });

            var recordedChunks = [];

            var options = {mimeType: 'audio/webm'};
            mediaRecorder = new MediaRecorder(stream, options);
            mediaRecorder.ondataavailable = handleDataAvailable;
            mediaRecorder.start();

            function handleDataAvailable(event) {
                print("Handling");
                if (event.data.size > 0) {
                    recordedChunks.push(event.data);
                } else {
                    // ...
                }
            }

            const stopButton = document.getElementById('stop');
            stopButton.addEventListener('click', function(){
                print("Stopping Recording");
                mediaRecorder.stop();
                download();
            });

            function download() {
                var blob = new Blob(recordedChunks, {
                    type: 'audio/webm'
                });
                var url = URL.createObjectURL(blob);
                var a = document.createElement('a');
                document.body.appendChild(a);
                a.style = 'display: none';
                a.href = url;
                a.download = 'test.webm';
                a.click();
                window.URL.revokeObjectURL(url);
            }
            */

            /*
            let stream = null;
            const downloadLink = document.getElementById('download');
            const stopButton = document.getElementById('stop');
            const startButton = document.getElementById('start');

            const options = {mimeType: 'audio/webm'};
            const recordedChunks = [];
            let mediaRecorder = new MediaRecorder(stream, options);

            stopButton.addEventListener('click', function(){
                print("Stopping Recording");
                mediaRecorder.stop();
            });

            startButton.addEventListener('click', function(){
                print("Starting Recording");
                mediaRecorder = new MediaRecorder(stream, options);
                mediaRecorder.start();
            });

            mediaRecorder.ondataavailable = handleData;

            function handleData(event){
                print(event.data.size)
            }

            function getAudioPermissions(){
                print("asdf");
                stream = navigator.mediaDevices.getUserMedia({ audio: true, video: false });
            }
            */
        </script>


    </body>
</html>